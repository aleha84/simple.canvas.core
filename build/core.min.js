function Box(n,t){this.topLeft=n;this.size=t;this.center=new Vector2(this.topLeft.x+t.x/2,this.topLeft.y+t.y/2);this.bottomRight=new Vector2(this.topLeft.x+this.size.x,this.topLeft.y+this.size.y);this.topRight=new Vector2(this.bottomRight.x,this.topLeft.y);this.bottomLeft=new Vector2(this.topLeft.x,this.bottomRight.y);this.update=function(n,t){this.topLeft=n;t!==undefined&&(this.size=t);this.center=new Vector2(this.topLeft.x+this.size.x/2,this.topLeft.y+this.size.y/2);this.bottomRight=new Vector2(this.topLeft.x+this.size.x,this.topLeft.y+this.size.y)};this.isPointInside=function(n){return n instanceof Vector2&&this.topLeft.x<=n.x&&n.x<=this.bottomRight.x&&this.topLeft.y<=n.y&&n.y<=this.bottomRight.y};this.isIntersectsWithCircle=function(n){return boxCircleIntersects(n,this)};this.isIntersectsWithBox=function(n){return boxIntersectsBox(this,n)};this.render=function(n){var t={fillStyle:"rgba(0, 255, 0, 0.5)",lineWidth:1,strokeStyle:"#00FF00"};isBoolean(n)?t.fill=n:extend(t,n);SCG.context.beginPath();SCG.context.rect(this.topLeft.x,this.topLeft.y,this.size.x,this.size.y);t.fill&&(SCG.context.fillStyle=t.fillStyle,SCG.context.fill());SCG.context.lineWidth=t.lineWidth;SCG.context.strokeStyle=t.strokeStyle;SCG.context.closePath();SCG.context.stroke()}}(function(){"use strict";var i=typeof module!="undefined"&&module.exports,r=typeof Element!="undefined"&&"ALLOW_KEYBOARD_INPUT"in Element,n=function(){for(var t,r,i=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],n=0,f=i.length,u={};n<f;n++)if(t=i[n],t&&t[1]in document){for(n=0,r=t.length;n<r;n++)u[i[0][n]]=t[n];return u}return!1}(),t={request:function(t){var i=n.requestFullscreen;t=t||document.documentElement;/5\.1[\.\d]* Safari/.test(navigator.userAgent)?t[i]():t[i](r&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){document[n.exitFullscreen]()},toggle:function(n){this.isFullscreen?this.exit():this.request(n)},raw:n};if(!n){i?module.exports=!1:window.screenfull=!1;return}Object.defineProperties(t,{isFullscreen:{get:function(){return!!document[n.fullscreenElement]}},element:{enumerable:!0,get:function(){return document[n.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return!!document[n.fullscreenEnabled]}}});i?module.exports=t:window.screenfull=t})();String.format||(String.format=function(n){var t=Array.prototype.slice.call(arguments,1);return n.replace(/{(\d+)}/g,function(n,i){return typeof t[i]!="undefined"?t[i]:n})});var SCG={test:"test"};SCG.AI={};SCG.space=undefined;SCG.viewfield={"default":{width:500,height:300},width:500,height:300,current:undefined};SCG.canvas=undefined;SCG.canvasId="mainCanvas";SCG.canvasBg=undefined;SCG.canvasBgId="backgroundCanvas";SCG.canvasUI=undefined;SCG.canvasUIId="uiCanvas";SCG.context=undefined;SCG.contextBg=undefined;SCG.contextUI=undefined;SCG.gameLogics={isPaused:!1,isPausedStep:!1,gameOver:!1,wrongDeviceOrientation:!1,messageToShow:"",isMobile:!1,pausedFrom:undefined,pauseDelta:0,doPauseWork:function(n){this.isPaused&&this.pausedFrom==undefined?(this.pausedFrom=n,this.pauseDelta=0):this.pausedFrom==undefined||this.isPaused?this.pauseDelta!=0&&(this.pauseDelta=0):(this.pauseDelta=n-this.pausedFrom,this.pausedFrom=undefined)},pauseToggle:function(){SCG.gameLogics.isPaused=!SCG.gameLogics.isPaused;SCG.UI.invalidate();SCG.audio&&SCG.audio.playPause(SCG.gameLogics.isPaused)}};SCG.go=[];SCG.gameControls={scale:{times:1},selectedGOs:[],camera:{mode:"free",shiftSpeed:5,centeredOn:undefined,resetAfterUpdate:!1,preventModeSwitch:!1,shifts:{left:!1,right:!1,up:!1,down:!1},free:function(){this.preventModeSwitch||(SCG.gameControls.camera.mode="free",this.centeredOn=undefined)},center:function(n){if(!this.preventModeSwitch){var t=SCG.gameControls;n==undefined&&t.selectedGOs.length==1&&(n=t.selectedGOs[0]);n?(t.camera.mode="centered",this.centeredOn=n):this.free()}},reset:function(){var n=this.shifts;n.left=!1;n.right=!1;n.up=!1;n.down=!1},update:function(){var i=this.shifts,n=undefined,t,r;this.mode==="free"?(t=undefined,i.left&&(t=V2.left()),i.right&&(t=V2.right()),i.up&&(t!=undefined?t.add(V2.up()):t=V2.up()),i.down&&(t!=undefined?t.add(V2.down()):t=V2.down()),t!==undefined&&(r=t.mul(this.shiftSpeed),n=SCG.viewfield.current.topLeft.add(r))):this.mode==="centered"&&this.centeredOn!==undefined&&(n=this.centeredOn.position.substract(new V2(SCG.viewfield.default.width/2,SCG.viewfield.default.height/2)));this.resetAfterUpdate&&this.reset();n!=undefined&&(n.x<0&&(n.x=0),n.y<0&&(n.y=0),n.x+SCG.viewfield.current.width>SCG.space.width&&(n.x=SCG.space.width-SCG.viewfield.current.width),n.y+SCG.viewfield.current.height>SCG.space.height&&(n.y=SCG.space.height-SCG.viewfield.current.height),SCG.viewfield.current.update(n))}},mousestate:{position:new V2,delta:new V2,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,timer:undefined,reset:function(){this.leftButtonDown=!1;this.rightButtonDown=!1;this.middleButtonDown=!1},stopped:function(){SCG.gameControls.mousestate.delta=new V2},toString:function(){return"position: "+this.position.toString()+"<br/>leftButtonDown: "+this.leftButtonDown},doClickCheck:function(){for(var n,u,t,i=SCG.gameControls,r=0;r<this.eventHandlers.click.length;r++)if(n=this.eventHandlers.click[r],n.renderBox!=undefined&&n.renderBox.isPointInside(i.mousestate.position)&&n.handlers!=undefined&&n.handlers.click!=undefined&&isFunction(n.handlers.click)){if(u=n.handlers.click.call(n),u&&u.preventBubbling)return;break}t=SCG.scenes.activeScene.game;t.clickHandler!=undefined&&isFunction(t.clickHandler)&&t.clickHandler(i.mousestate.position.division(i.scale.times))},eventHandlers:{click:[]}},keyboardstate:{altPressed:!1,shiftPressed:!1,ctrlPressed:!1},mouseDown:function(n){var t=SCG.gameControls.mousestate;if(n.type=="touchstart")n.originalEvent.changedTouches!=undefined&&n.originalEvent.changedTouches.length==1&&(t.leftButtonDown=!0);else switch(n.which){case 1:t.leftButtonDown=!0;break;case 2:t.middleButtonDown=!0;break;case 3:t.rightButtonDown=!0;break;default:t.reset()}},mouseOut:function(){SCG.gameControls.mousestate.reset()},mouseUp:function(n){var i=this,t=SCG.gameControls.mousestate;if(i.getEventAbsolutePosition(n),n.type=="touchstart")n.originalEvent.changedTouches!=undefined&&n.originalEvent.changedTouches.length==1&&(t.leftButtonDown=!1);else switch(n.which){case 1:t.leftButtonDown=!1;break;case 2:t.middleButtonDown=!1;break;case 3:t.rightButtonDown=!1;break;default:t.reset()}i.mousestate.doClickCheck();n.preventDefault()},mouseMove:function(n){var i=this,t=SCG.gameControls.mousestate,r=t.position.clone();i.getEventAbsolutePosition(n);t.delta=t.position.substract(r);SCG.debugger&&SCG.debugger.setValue(t.toString())},getEventAbsolutePosition:function(n){var t=pointerEventToXY(n);SCG.gameControls.mousestate.position=new V2(t.x-SCG.canvasUI.margins.left,t.y-SCG.canvasUI.margins.top)},orientationChangeEventInit:function(){var n=this;SCG.gameControls.permanentEventInit();addListenerMulti(window,"orientationchange resize",function(){n.graphInit()});SCG.gameLogics.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);SCG.gameLogics.isMobile&&(setTimeout(function(){window.scrollTo(0,1)},100),addListenerMulti(document,"fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",function(){n.graphInit()}));this.graphInit()},graphInit:function(){var t=SCG.gameLogics,n=SCG.viewfield,s,i,r,o;if(t.messageToShow="",t.wrongDeviceOrientation=!window.matchMedia("(orientation: landscape)").matches,t.wrongDeviceOrientation){t.messageToShow="wrong device orientation - portrait";return}if(s=window.innerWidth,s<n.default.width){t.messageToShow=String.format("width lesser than {3} (width: {0}, iH: {1}, iW: {2})",s,window.innerHeight,window.innerWidth,n.default.width);t.wrongDeviceOrientation=!0;return}var u=Math.max(document.documentElement.clientWidth,window.innerWidth||0),f=Math.max(document.documentElement.clientHeight,window.innerHeight||0),h=u/n.default.width,c=f/n.default.height,e=SCG.gameControls.scale;if(e.times=Math.min(h,c),e.times<1){t.messageToShow=String.format("window is to small (width: {0}, height: {1})",u,f);t.wrongDeviceOrientation=!0;return}n.width=n.default.width*e.times;n.height=n.default.height*e.times;i=0;r=0;n.width<u?r=Math.round((u-n.width)/2):n.height<f&&(i=Math.round((f-n.height)/2));this.setCanvasProperties(SCG.canvas,i,r);this.setCanvasProperties(SCG.canvasBg,i,r);this.setCanvasProperties(SCG.canvasUI,i,r);o=SCG.scenes.activeScene.backgroundRender;o!=undefined&&isFunction(o)&&o();SCG.UI.invalidate()},setCanvasProperties:function(n,t,i){var r=SCG.viewfield;setAttributes(n,{width:r.width,height:r.height,css:{width:r.width+"px",height:r.height+"px","margin-top":t+"px","margin-left":i+"px"}});n.width=r.width;n.height=r.height;n.margins={top:t,left:i}},permanentEventInit:function(){var n=this;document.addEventListener("keydown",function(t){n.permanentKeyDown(t)},!1);document.addEventListener("keyup",function(t){n.permanentKeyUp(t)},!1);addListenerMulti(SCG.canvasUI,"mousedown touchstar",function(t){absorbTouchEvent(t);t.type=="touchstart"&&n.mouseMove(t);n.mouseDown(t)});addListenerMulti(SCG.canvasUI,"mouseup touchend",function(t){absorbTouchEvent(t);n.mouseUp(t)});addListenerMulti(SCG.canvasUI,"mouseout touchleave",function(t){absorbTouchEvent(t);n.mouseOut(t)});addListenerMulti(SCG.canvasUI,"mousemove touchmove",function(t){absorbTouchEvent(t);n.mouseMove(t)});SCG.canvasUI.addEventListener("contextmenu",function(n){return n.preventDefault(),!1},!1)},permanentKeyDown:function(n){var t=this.keyboardstate;t.shiftPressed=n.shiftKey;t.ctrlPressed=n.ctrlKey;t.altPressed=n.altKey},permanentKeyUp:function(n){var t=this.keyboardstate;t.shiftPressed=n.shiftKey;t.ctrlPressed=n.ctrlKey;t.altPressed=n.altKey;switch(n.which){case 32:n.shiftKey?SCG.gameLogics.isPausedStep=!0:SCG.gameLogics.pauseToggle()}}};SCG.debugger={el:getDOMByClassName(".debugger"),initialized:!1,init:function(){this.el=getDOMByClassName(".debugger");this.el==undefined&&(this.el=appendDomElement(document.body,"div",{"class":"debugger"}));this.initialized=!0},clear:function(){this.setValue("")},setValue:function(n){this.initialized||this.init();this.el.innerHTML=n}};SCG.GO={};SCG.GO.GO=function(n){if(this.defaultInitProperties={},this.position=new V2,this.renderPosition=new V2,this.renderBox=undefined,this.alive=!0,this.static=!1,this.type="unidentifiedType",this.id="",this.size=new V2,this.renderSize=new V2,this.direction=new V2,this.speed=0,this.angle=0,this.context=undefined,this.contextName="context",this.img=undefined,this.imgPropertyName=undefined,this.selected=!1,this.playerControllable=!1,this.destination=undefined,this.path=[],this.mouseOver=!1,this.randomizeDestination=!1,this.randomizeDestinationRadius=new V2,this.setDeadOnDestinationComplete=!1,this.isCustomRender=!1,this.handlers={},this.isAnimated=!1,this.animation={totalFrameCount:0,framesInRow:0,framesRowsCount:0,frameChangeDelay:0,destinationFrameSize:new V2,sourceFrameSize:new V2,currentDestination:new V2,currentFrame:0,reverse:!1,paused:!1,loop:!1,animationTimer:undefined,animationEndCallback:function(){},frameChange:function(){var n=this.animation,t,i;if(!n.paused){if(n.reverse?n.currentFrame--:n.currentFrame++,!n.reverse&&n.currentFrame>n.totalFrameCount||n.reverse&&n.currentFrame<1)if(n.loop)n.currentFrame=n.reverse?n.totalFrameCount:1;else{n.animationEndCallback.call(this);return}t=Math.ceil(n.currentFrame/n.framesInRow);i=n.framesInRow-(t*n.framesInRow-n.currentFrame);n.currentDestination=new V2(i-1,t-1)}}},n==undefined)throw"SCG.GO.GO -> props are undefined";if(n.size==undefined||n.size.equal(new V2))throw"SCG.GO.GO -> size is undefined";extend(!0,this,n);this.isAnimated&&(this.size=this.animation.destinationFrameSize.clone(),this.animation.currentFrame=0,this.animation.animationTimer={lastTimeWork:new Date,delta:0,currentDelay:this.animation.frameChangeDelay,originDelay:this.animation.frameChangeDelay,doWorkInternal:this.animation.frameChange,context:this});SCG.GO.GO.counter[this.type]==undefined&&(SCG.GO.GO.counter[this.type]=0);this.id=this.type+ ++SCG.GO.GO.counter[this.type];this.creationTime=new Date;this.regClick();this.initializer!=undefined&&isFunction(this.initializer)&&this.initializer(this);this.img==undefined&&this.imgPropertyName!=undefined&&(this.img=SCG.images[this.imgPropertyName]);SCG.AI.worker&&SCG.AI.sendEvent({type:"created",message:{goType:this.type,id:this.id,position:this.position.clone()}})};SCG.GO.GO.counter={};SCG.GO.GO.prototype={constructor:SCG.GO.GO,beforeDead:function(){},setDead:function(){this.beforeDead();var n=SCG.gameControls.mousestate.eventHandlers,t=n.click.indexOf(this);t>-1&&n.click.splice(t,1);SCG.AI.worker&&SCG.AI.sendEvent({type:"removed",message:{goType:this.type,id:this.id}});this.alive=!1},isAlive:function(){return this.alive},render:function(){var t,f;if(!this.alive||!this.renderPosition)return!1;if(this.internalPreRender(),this.isCustomRender)this.customRender();else if(this.img!=undefined){var i=this.renderPosition,n=this.renderSize,r=this.destSourcePosition,e=this.size,u=this.context;this.isAnimated?(t=this.animation,u.drawImage(this.img,t.currentDestination.x*t.sourceFrameSize.x,t.currentDestination.y*t.sourceFrameSize.y,t.sourceFrameSize.x,t.sourceFrameSize.y,i.x-n.x/2,i.y-n.y/2,n.x,n.y)):r!=undefined?(f=this.destSourceSize?this.destSourceSize:this.size,u.drawImage(this.img,r.x,r.y,f.x,f.y,i.x-n.x/2,i.y-n.y/2,n.x,n.y)):u.drawImage(this.img,i.x-n.x/2,i.y-n.y/2,n.x,n.y)}this.internalRender()},customRender:function(){},internalPreRender:function(){},internalRender:function(){},update:function(n){var t=SCG.gameControls.scale;if(this.renderSize=this.size.mul(t.times),this.box=new Box(new V2(this.position.x-this.size.x/2,this.position.y-this.size.y/2),this.size),this.renderPosition=undefined,(SCG.viewfield.current.isIntersectsWithBox(this.box)||this.static)&&(this.renderPosition=this.position.add(this.static?new V2:SCG.viewfield.current.topLeft.mul(-1)).mul(t.times),this.renderBox=new Box(new V2(this.renderPosition.x-this.renderSize.x/2,this.renderPosition.y-this.renderSize.y/2),this.renderSize)),this.img==undefined&&this.imgPropertyName!=undefined&&(this.img=SCG.images[this.imgPropertyName],this.img==undefined))throw"Cant achieve image named: "+this.imgPropertyName;if(this.context==undefined&&this.contextName!=undefined&&(this.context=SCG.contexts[this.contextName],this.context==undefined))throw"Cant achieve context named: "+this.contextName;if(!this.static&&(!this.alive||SCG.gameLogics.isPaused||SCG.gameLogics.gameOver||SCG.gameLogics.wrongDeviceOrientation)||(this.mouseOver=!1,this.internalPreUpdate(n),!this.alive))return!1;if(this.destination&&(this.position.distance(this.destination)<=this.speed?this.setDestination():this.position.add(this.direction.mul(this.speed),!0)),this.destination==undefined)if(this.path.length>0)this.setDestination(this.path.shift());else if(this.setDeadOnDestinationComplete)return this.setDead(),!1;return this.isAnimated&&doWorkByTimer(this.animation.animationTimer,n),this.internalUpdate(n),this.alive?void 0:!1},internalPreUpdate:function(){},internalUpdate:function(){},setDestination:function(n){if(n!==undefined&&n instanceof V2){if(this.randomizeDestination){var t=this.randomizeDestinationRadius;n.add(new V2(getRandom(-t,t),getRandom(-t,t)),!0)}this.destination=n;this.direction=this.position.direction(this.destination)}else this.destination=undefined,this.direction=new V2},renderSelectBox:function(){var n=this.selectBoxColor;n===undefined&&(n={max:255,min:100,current:255,direction:1,step:1,colorPattern:"rgb({0},0,0)"},this.playerControllable&&(n.colorPattern="rgb(0,{0},0)"));this.renderBox.render({fill:!1,strokeStyle:String.format(n.colorPattern,n.current),lineWidth:2});(n.current>=n.max||n.current<=n.min)&&(n.direction*=-1);n.current+=n.step*n.direction},clickHandler:function(){},regClick:function(){if(this.handlers.click&&isFunction(this.handlers.click)){var n=SCG.gameControls.mousestate.eventHandlers;n.click.indexOf(this)==-1&&n.click.push(this)}}};SCG.GO.goBaseProperties={};SCG.GO.create=function(n,t){if(n==undefined)throw"SCG.GO.create -> name is empty";t==undefined&&(t={});var i=SCG.GO.goBaseProperties[n];if(i==undefined)throw"SCG.GO.create -> can't find base properties ba provided name "+n;return new SCG.GO.GO(extend(!0,{},i,t))};SCG.GO.register=function(n,t){if(n==undefined)throw"SCG.GO.register -> name is empty";if(t==undefined)throw"SCG.GO.register -> baseProperties is undefined";SCG.GO.goBaseProperties[n]=t};SCG.frameCounter={lastTimeCheck:new Date,checkDelta:1e3,prevRate:0,current:0,renderConsumption:{begin:new Date,end:new Date},visibleCount:0,draw:function(){var n=SCG.context;n.save();n.fillStyle="red";n.font="48px serif";n.fillText(this.prevRate,SCG.viewfield.width-60,40);n.font="24px serif";n.fillText(this.visibleCount,SCG.viewfield.width-60,80);SCG.gameLogics.messageToShow!=""&&(n.fillStyle="black",n.font="24px serif",n.fillText(SCG.gameLogics.messageToShow,10,40));SCG.frameCounter.visibleCount=0;n.restore()},doWork:function(n){n-this.lastTimeCheck>this.checkDelta?(this.prevRate=this.current,this.current=0,this.lastTimeCheck=n):this.current++;this.draw()}};SCG.src={};SCG.images={};SCG.contexts={};SCG.globals={addDefaultUIButtons:!0};SCG.customInitializaers=[];window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}();SCG.initializer=function(n){var r=0,i=0;for(var t in SCG.src)i++;for(t in SCG.src)SCG.images[t]=new Image,SCG.images[t].onload=function(){++r>=i&&n()},SCG.images[t].src=SCG.src[t];i==0&&n()};SCG.customInitialization=function(){if(SCG.customInitializaers.length!=0)for(var n=0;n<SCG.customInitializaers.length;n++)isFunction(SCG.customInitializaers[n])&&SCG.customInitializaers[n]()};SCG.scenes={activeScene:undefined,scenes:{},selectScene:function(n,t){if(this.scenes[n]==undefined)throw String.format("Scene {0} not found!",n);this.activeScene&&this.activeScene.dispose&&this.activeScene.dispose();this.activeScene=this.scenes[n];var i=this.activeScene,r=SCG.gameControls.mousestate.eventHandlers;r.click=[];i.go.forEach(function(n){n.regClick()});SCG.contextBg&&(SCG.contextBg.clearRect(0,0,SCG.viewfield.width,SCG.viewfield.height),i.backgroundRender!=undefined&&isFunction(i.backgroundRender)&&i.backgroundRender());SCG.AI.initialize();i.ui=[];SCG.globals.addDefaultUIButtons&&SCG.UI.addDefaultUIButtons();SCG.contextUI&&SCG.UI.invalidate();SCG.space={width:i.space.width,height:i.space.height};i.start!=undefined&&isFunction(i.start)&&i.start(t)},registerScene:function(n){var t,i,r;if(n.name===undefined)throw"Can't register scene without name";if(t=n.gameObjectsBaseProperties,t!=undefined&&isArray(t))for(i=0;i<t.length;i++){if(r=t[i].type,SCG.GO.goBaseProperties[r]!=undefined)throw String.format("SCG.scenes.registerScene -> BaseProperty with type '{0} already registered'",r);SCG.GO.register(r,t[i])}this.scenes[n.name]={name:n.name,start:n.start!==undefined&&isFunction(n.start)?n.start:undefined,dispose:n.dispose!==undefined&&isFunction(n.dispose)?n.dispose:undefined,preMainWork:n.preMainWork!==undefined&&isFunction(n.preMainWork)?n.preMainWork.bind(this):undefined,afterMainWork:n.afterMainWork!==undefined&&isFunction(n.afterMainWork)?n.afterMainWork.bind(this):undefined,go:n.gameObjectGenerator!=undefined&&isFunction(n.gameObjectGenerator)?n.gameObjectGenerator():[],backgroundRender:n.backgroundRender!=undefined&&isFunction(n.backgroundRender)?n.backgroundRender:undefined,game:extend(!0,{},n.game),space:n.space?n.space:{width:SCG.viewfield.default.width,height:SCG.viewfield.default.height},ui:[],unshift:[]}}};SCG.AI.initialize=function(){SCG.AI.worker&&(SCG.AI.worker.terminate(),SCG.AI.worker=undefined,URL.revokeObjectURL(SCG.AI.blobURL));var n=SCG.scenes.activeScene.game;n&&n.AI&&(SCG.AI.blobURL=URL.createObjectURL(new Blob(["(","function(){var queue = [];\nconsole.log('worker start');\nvar queueProcesser =\n"+(n.AI.queueProcesser!=undefined&&isFunction(n.AI.queueProcesser)?n.AI.queueProcesser.toString():"function(){}")+"\nfunction processMessageQueue(){\nif(queue.length > 0){\nqueueProcesser();\n}\nsetTimeout(processMessageQueue, 100);\n}\nself.onmessage = function(e){\nvar msg = e.data;\nswitch(msg.command){\ncase 'event':\nqueue.push(msg.event);\nbreak;\ncase 'initialize':\nself.environment=msg.environment;\nself.importScripts(msg.url + 'utils.min.js');\nqueue.push({type: 'start', message: undefined})\nbreak;\ndefault:\nbreak;\n}\n}\nprocessMessageQueue();\n}",")()"],{type:"application/javascript"})),SCG.AI.worker=new Worker(SCG.AI.blobURL));SCG.AI.worker&&n.AI.messagesProcesser!=undefined&&isFunction(n.AI.messagesProcesser)&&(SCG.AI.worker.onmessage=function(t){n.AI.messagesProcesser(t.data)})};SCG.AI.initializeEnvironment=function(n){var t=document.location.href,i=t.indexOf("index");i!=-1&&(t=t.substring(0,i));SCG.AI.worker.postMessage({command:"initialize",environment:n,url:t})};SCG.AI.sendEvent=function(n){SCG.AI.worker.postMessage({command:"event",event:n})};SCG.UI={initialized:!1,invalidate:function(){if(SCG.contextUI){SCG.contextUI.clearRect(0,0,SCG.viewfield.width,SCG.viewfield.height);for(var n=SCG.scenes.activeScene,t=n.ui.length;t--;)n.ui[t].update(),n.ui[t].render()}},addDefaultUIButtons:function(){var u=SCG.scenes.activeScene,n=SCG.viewfield.default,t=SCG.GO.create("button",{position:new Vector2,isFullscreen:!1,transparency:.75,handlers:{click:function(){return this.isFullscreen=!this.isFullscreen,screenfull.toggle(document.documentElement),{preventBubbling:!0}}},internalUpdate:function(){var n=this.size,t=this.innerCanvasContext;t.clearRect(0,0,n.x,n.y);drawFigures(t,this.isFullscreen?[[new Vector2(0,n.y*.475),new Vector2(n.x*.475,0),new Vector2(n.x*.475,n.y*.475)],[new Vector2(n.x*.525,n.y*.525),new Vector2(n.x,n.y*.525),new Vector2(n.x*.525,n.y)]]:[[new Vector2(0,0),new Vector2(n.x*.75,0),new Vector2(0,n.y*.75)],[new Vector2(n.x*.25,n.y),new Vector2(n.x,n.y),new Vector2(n.x,n.y*.25)]],{alpha:this.transparency,fill:"darkgrey"})}}),i,r;t.position=new Vector2(n.width-t.size.x/2,n.height-t.size.y/2);u.ui.push(t);i=SCG.GO.create("button",{position:new Vector2,transparency:.75,handlers:{click:function(){return SCG.gameLogics.pauseToggle(),{preventBubbling:!0}}},internalUpdate:function(){var n=this.size,t=this.innerCanvasContext;t.clearRect(0,0,n.x,n.y);drawFigures(t,SCG.gameLogics.isPaused?[[new Vector2(n.x*.2,0),new Vector2(n.x*.8,n.y*.5),new Vector2(n.x*.2,n.y)]]:[[new Vector2(n.x*.2,0),new Vector2(n.x*.4,0),new Vector2(n.x*.4,n.y),new Vector2(n.x*.2,n.y)],[new Vector2(n.x*.6,0),new Vector2(n.x*.8,0),new Vector2(n.x*.8,n.y),new Vector2(n.x*.6,n.y)]],{alpha:this.transparency,fill:"darkgrey"})}});i.position=new Vector2(n.width-t.size.x-i.size.x/2,n.height-i.size.y/2);u.ui.push(i);SCG.audio&&(r=SCG.GO.create("button",{position:new Vector2,transparency:.75,handlers:{click:function(){return SCG.audio.muteToggle(),SCG.UI.invalidate(),{preventBubbling:!0}}},internalUpdate:function(){var n=this.size,t=this.innerCanvasContext;t.clearRect(0,0,n.x,n.y);drawFigures(t,SCG.audio.mute?[[new Vector2(n.x*.1,n.y*.3),new Vector2(n.x*.3,n.y*.3),new Vector2(n.x*.5,0),new Vector2(n.x*.5,n.y),new Vector2(n.x*.3,n.y*.7),new Vector2(n.x*.1,n.y*.7)]]:[[new Vector2(n.x*.1,n.y*.3),new Vector2(n.x*.3,n.y*.3),new Vector2(n.x*.5,0),new Vector2(n.x*.5,n.y),new Vector2(n.x*.3,n.y*.7),new Vector2(n.x*.1,n.y*.7)],[new Vector2(n.x*.55,n.y*.4),new Vector2(n.x*.65,n.y*.4),new Vector2(n.x*.65,n.y*.6),new Vector2(n.x*.55,n.y*.6)],[new Vector2(n.x*.75,n.y*.2),new Vector2(n.x*.85,n.y*.2),new Vector2(n.x*.85,n.y*.8),new Vector2(n.x*.75,n.y*.8)]],{alpha:this.transparency,fill:"darkgrey"})}}),r.position=new Vector2(n.width-t.size.x-i.size.x-r.size.x/2,n.height-r.size.y/2),u.ui.push(r))},initialize:function(){if(!this.initialized)for(var n=0;n<this.controls.length;n++)SCG.GO.register(this.controls[n].type,this.controls[n])},helpers:{createCanvas:function(n){n.innerCanvas=document.createElement("canvas");var t=n.innerCanvas;t.width=n.size.x;t.height=n.size.y;n.innerCanvasContext=t.getContext("2d");n.img=n.innerCanvas}}};SCG.UI.controls=[{type:"button",size:new Vector2(50,50),contextName:"contextUI",innerCanvas:undefined,transparency:1,static:!0,text:undefined,useInnerCanvas:!0,border:!1,initializer:function(n){var t,i,r;if(this.useInnerCanvas&&(SCG.UI.helpers.createCanvas(n),t=n.innerCanvasContext,this.text!=undefined)){if(i=0,this.text.autoSize){r=300;do r--,t.font=r+"px "+this.text.font,i=t.measureText(this.text.value).width;while(i>this.size.x*.8)}else t.font=this.text.font,i=t.measureText(this.text.value).width;t.fillText(this.text.value,this.size.x/2-i/2,this.size.y/2+r/2);t.rect(1,1,this.size.x-1,this.size.y-1);t.stroke()}},internalRender:function(){if(this.border){var t=this.renderPosition,n=this.renderSize;this.context.rect(t.x-n.x/2,t.y-n.y/2,n.x,n.y);this.context.stroke()}}},{type:"label",size:new V2(50,10),innerCanvas:undefined,contextName:"contextUI",static:!0,text:{value:"sample",format:undefined,font:"px Arial",size:20,color:"black",border:!1,align:"center"},initializer:function(n){SCG.UI.helpers.createCanvas(n)},internalUpdate:function(){var t=this.innerCanvasContext,r=this.size,n=this.text,i;t.clearRect(0,0,r.x,r.y);t.font=n.size+n.font;t.fillStyle=n.color;i=n.value;n.format&&(i=String.format(n.format,n.value));t.textAlign=n.align;t.textBaseline="middle";t.fillText(i,this.size.x/2,this.size.y/2);n.border&&(t.rect(1,1,this.size.x-1,this.size.y-1),t.stroke())}},{type:"image",contextName:"contextUI",size:new V2(50,50),static:!0}];SCG.UI.initialize();SCG.audio={pause:!1,initialized:!1,mute:!1,players:[],notes:{dur:{_1:1,_2:.5,_4:.25,_8:.125,_16:.0625,_32:.03125},pause:0},init:function(){var i,n,t;if(!this.initialized){try{window.AudioContext=window.AudioContext||window.webkitAudioContext;this.context=new AudioContext}catch(r){alert("Web Audio API is not supported in this browser")}for(i=["c","c_sh","d","d_sh","e","f","f_sh","g","g_sh","a","a_sh","h"],n=0;n<9;n++)for(this.notes["o"+n]={},t=0;t<12;t++)this.notes["o"+n][i[t]]=440*Math.pow(2,((n-4)*12+(t-9))/12);this.initialized=!0}},playPause:function(n){this.connectToggle(n)},muteToggle:function(){this.mute=!this.mute;this.connectToggle(this.mute)},connectToggle:function(n){for(var t=0;t<this.players.length;t++)this.players[t].connectToggle(n)},update:function(n){for(var t=this.players.length,i;t--;)i=this.players[t],i.update(n),i.isAlive||this.players.splice(t,1)},start:function(n){this.initialized||this.init();n.context=this.context;n.mute=this.mute;this.players.push(new SCG.audio.Player(n))}};SCG.audio.init();SCG.audio.Player=function(n){if(this.loop=!1,this.notes=[],this.noteIndex=-1,this.curVol=0,this.maxVol=.05,this.context=undefined,this.gainNodes=[],this.currentNote=undefined,this.isAlive=!0,this.length=1e3,this.type="triangle",this.notesChangeTimer={ignorePause:!0,lastTimeWork:new Date,delta:0,currentDelay:0,originDelay:0,doWorkInternal:undefined,context:undefined},n==undefined)throw"SCG.audio.Player -> props are undefined";extend(!0,this,n);this.notesChangeTimer.doWorkInternal=this.noteChange;this.notesChangeTimer.context=this;this.curVol=this.maxVol;this.noteIndex=-1;this.noteChange()};SCG.audio.Player.prototype={constructor:SCG.audio.Player,update:function(n){this.isAlive&&doWorkByTimer(this.notesChangeTimer,n)},noteChange:function(){if(this.isAlive){if(this.noteIndex++,this.noteIndex>=this.notes.length)if(this.loop)this.noteIndex=0;else{this.isAlive=!1;return}this.setValues(this.notes[this.noteIndex])}},setValues:function(n){var r=[],f,u,i,t;for(this.gainNodes=[],isArray(n.value)?r=n.value:r.push(n.value),f=n.duration*this.length,u=0;u<r.length;u++)r[u]!=0&&(i=this.context.createOscillator(),t=this.context.createGain(),this.mute||(i.connect(t),t.connect(this.context.destination)),i.type=this.type,t.gain.value=this.maxVol,t.gain.setValueAtTime(this.curVol,this.context.currentTime),t.gain.exponentialRampToValueAtTime(.0001,this.context.currentTime+f*3/1e3),i.frequency.value=r[u],this.gainNodes.push(t),i.start(0),i.stop(this.context.currentTime+n.duration*4),i.onended=function(){t.disconnect()});this.notesChangeTimer.originDelay=f;this.notesChangeTimer.currentDelay=f},connectToggle:function(n){this.mute=n;for(var t=0;t<this.gainNodes.length;t++)n?this.gainNodes[t].disconnect(this.context.destination):this.gainNodes[t].connect(this.context.destination)}};SCG.start=function(){SCG.canvasBg||(SCG.canvasBg=appendDomElement(document.body,"canvas",{width:SCG.viewfield.width,height:SCG.viewfield.height,id:SCG.canvasBgId,css:{"z-index":0,position:"absolute"}}),SCG.contextBg=SCG.canvasBg.getContext("2d"),SCG.contexts.contextBg=SCG.contextBg);SCG.canvas||(SCG.canvas=appendDomElement(document.body,"canvas",{width:SCG.viewfield.width,height:SCG.viewfield.height,id:SCG.canvasId,css:{"z-index":1,position:"absolute"}}),SCG.context=SCG.canvas.getContext("2d"),SCG.contexts.context=SCG.context);SCG.canvasUI||(SCG.canvasUI=appendDomElement(document.body,"canvas",{width:SCG.viewfield.width,height:SCG.viewfield.height,id:SCG.canvasUIId,css:{"z-index":2,position:"absolute"}}),SCG.contextUI=SCG.canvasUI.getContext("2d"),SCG.contexts.contextUI=SCG.contextUI);SCG.initializer(function(){SCG.space==undefined&&(SCG.space={width:SCG.viewfield.default.width,height:SCG.viewfield.default.height});SCG.viewfield.current=new Box(new Vector2,new Vector2(SCG.viewfield.width,SCG.viewfield.height));SCG.customInitialization();SCG.gameControls.orientationChangeEventInit();SCG.UI.invalidate();SCG.audio&&SCG.audio.init();SCG.animate()})};SCG.preMainWork=function(){};SCG.afterMainWork=function(){};SCG.animate=function(){SCG.draw();requestAnimationFrame(SCG.animate)};SCG.draw=function(){var i,n,r,t,u;if(SCG.scenes.activeScene==undefined||SCG.scenes.activeScene.go==undefined)throw"Active scene corrupted!";if(i=new Date,SCG.gameLogics.doPauseWork(i),n=SCG.scenes.activeScene,n.preMainWork&&isFunction(n.preMainWork)&&n.preMainWork(),SCG.gameControls.camera.update(i),n.unshift.length>0){for(r=0;r<n.unshift.length;r++)n.go.unshift(n.unshift[r]);n.unshift=[]}for(t=n.go.length;t--;)n.go[t].update(i),n.go[t].render(),SCG.frameCounter&&n.go[t].renderPosition!=undefined&&SCG.frameCounter.visibleCount++,n.go[t].alive||(u=n.go.splice(t,1));n.afterMainWork&&isFunction(n.afterMainWork)&&n.afterMainWork();SCG.gameLogics.isPausedStep&&(SCG.gameLogics.isPausedStep=!1);SCG.frameCounter&&SCG.frameCounter.doWork(i);SCG.audio&&SCG.audio.update(i)};document.addEventListener("DOMContentLoaded",function(){SCG.src={};SCG.globals.items=[];SCG.globals.bgRender=function(){var n=SCG.contextBg,t=SCG.viewfield;n.beginPath();n.rect(0,0,t.width,t.height);n.fillStyle="gray";n.fill()};var t={name:"demo_s1",space:{width:1e3,height:1e3},dispose:function(){for(var n=0;n<this.game.intervals.length;n++)clearInterval(this.game.intervals[n])},start:function(){var t=this.game,r,i;t.AI.initialize();r=this;t.intervals.push(setInterval(function(){SCG.AI.sendEvent({type:"units",message:r.go.filter(function(n){return n.toPlain}).map(function(n){return n.toPlain()})})},200));t.playerUnit==undefined&&(i=SCG.GO.create("unit",{position:new V2(250,150),size:new V2(50,50),health:1e3,unitType:"Ranged"}),this.go.push(i),this.go.push(SCG.GO.create("unit",{position:new V2(150,50),size:new V2(50,50),side:2,health:1e3,speed:.5})),this.go.push(SCG.GO.create("unit",{position:new V2(400,50),size:new V2(50,50),side:2,health:1e3,speed:.5})),i.selected=!0,t.playerUnit=i,SCG.gameControls.camera.mode="centered",SCG.scenes.selectScene(n.name,{money:1e3,fromBattle:!0,gos:this.go.filter(function(n){return n.side==1})}));SCG.gameControls.camera.center(t.playerUnit)},backgroundRender:function(){var n=SCG.contextBg,t=SCG.viewfield;n.beginPath();n.rect(0,0,t.width,t.height);n.fillStyle="gray";n.fill()},preMainWork:function(){var n=SCG.viewfield;SCG.context.clearRect(0,0,n.width,n.height)},game:{money:0,playerUnit:undefined,clickHandler:function(n){if(this.playerUnit){var t=n.add(SCG.viewfield.current.topLeft);this.playerUnit.setDestination(t)}},intervals:[],AI:{initialize:function(){SCG.AI.initializeEnvironment({space:{width:SCG.space.width,height:SCG.space.height},units:{ai:[],player:[],history:{}}})},messagesProcesser:function(n){var i,r,t;if(n!=undefined&&n.command)switch(n.command){case"move":for(i=SCG.scenes.activeScene,r=undefined,t=0;t<i.go.length;t++)if(i.go[t].id==n.message.id){i.go[t].setDestination(new V2(n.message.position));break}}},queueProcesser:function(){for(var h,n,c,l,t,f,a,e,o;queue.length;){h=queue.pop();switch(h.type){case"start":self.helpers={log:function(){console.log(self.environment)},move:function(n,t){self.postMessage({command:"move",message:{id:n,position:t}})}};break;case"units":for(n=self.environment.units,t=1;t<3;t++)n[t==1?"player":"ai"]=h.message.filter(function(n){return n.side==t}).map(function(n){return n.position=new V2(n.position),n});if(c=self.helpers,c==undefined||n.player.length==0)return;for(l=[],t=0;t<n.ai.length;t++){var i=n.ai[t],r=n.player.map(function(n){return{distance:i.position.distance(n.position),unit:n}}),u=r[0];if(r.length>1)for(f=1;f<r.length;f++)r[f].distance<u.distance&&(u=r[f]);if(a=n.history[u.unit.id],!a||!a.position.equal(u.unit.position)){var v=u.unit.position,y=i.position.direction(v).mul(-1),p=y,s=undefined;for(e=0;e<20;e++){if(s=v.add(p.mul(.8*i.range)),l.filter(function(n){return boxIntersectsBox({center:s,size:i.size},{center:n.dest,size:n.unit.size})}).length==0)break;p=y.rotate((Math.floor(e/2)+1)*10*(e%2==0?1:-1),!1,!1)}l.push({dest:s,unit:i});c.move(i.id,s)}}for(o=0;o<n.player.length;o++)n.history[n.player[o].id]=n.player[o]}}}}},gameObjectsBaseProperties:[{type:"unit",size:new V2(20,20),speed:1,imgPropertyName:"unit",jumpOptions:{current:-1,start:-1,end:1,step:.1},items:{weapon:undefined,shield:undefined,armor:undefined,helmet:undefined},level:1,experience:0,side:1,health:100,canAttack:!0,defence:1,damage:{min:2,max:5,crit:1},attackRadius:20,attackRate:500,unitType:"Fighter",stats:{str:0,agl:0,dex:0,con:0},initializer:function(n){n.attackRadius=n.size.x;n.attackDelayTimer={lastTimeWork:new Date,delta:0,currentDelay:0,originDelay:0,doWorkInternal:n.canAttackToggle,context:n};n.destSourcePosition=new V2((n.side-1)*50,0);var t=n.stats;switch(n.unitType){case"Fighter":t.str=2;t.con=1;break;case"Defender":t.agl=2;t.con=1;break;case"Ranged":t.con=2;t.str=1;t.agl=1;break;default:throw"Unknown unit type";}},handlers:{click:function(){var n,t;if(this.side==1){for(n=SCG.scenes.activeScene,t=0;t<n.go.length;t++)n.go[t].selected=!1;this.selected=!0;n.name=="management"?n.game.unitSelected(this):(n.game.playerUnit=this,SCG.gameControls.camera.center(n.game.playerUnit))}return{preventBubbling:!0}}},getStats:function(n){var i=this.items,t=i.weapon,r;switch(n){case"attackRadius":return this.attackRadius+(t?t.attackRadius:0);case"damage":return r=1+.2*this.stats.str,{min:parseFloat(((this.damage.min+(t?t.damage.min:0))*r).toFixed(1)),max:parseFloat(((this.damage.max+(t?t.damage.max:0))*r).toFixed(1)),crit:t?t.damage.crit:this.damage.crit};case"defence":return(this.defence+(i.armor?i.armor.defence:0)+(i.helmet?i.helmet.defence:0))*(1+.2*this.stats.agl);case"attackRate":return t?t.attackRate:this.attackRate;case"health":return this.health+this.stats.con*20;case"ranged":return t&&t.ranged?t.ranged:!1;case"expCap":return Math.pow(this.level,2)*100}},toPlain:function(){return{id:this.id,position:this.position,health:this.getStats("health"),damage:this.getStats("damage"),side:this.side,range:this.getStats("attackRadius"),size:this.size}},canAttackToggle:function(){this.canAttack=!this.canAttack;this.attackDelayTimer.lastTimeWork=new Date;this.attackDelayTimer.currentDelay=this.getStats("attackRate")},receiveAttack:function(n){var t=this.getStats("defence");(n-=t,n<=0&&(n=Math.random()<(1/((t-n)*1.5)?n/3:0),n<=0))||(n=parseFloat(n.toFixed(1)),SCG.scenes.activeScene.unshift.push(SCG.GO.create("fadingObject",{position:this.position.clone(),lifeTime:1e3,text:{size:12,color:"#ff2400",value:n},size:new V2(10,10),shift:new V2(.15,-.5)})),this.health-=n,this.getStats("health")<=0&&this.setDead())},beforeDead:function(){SCG.scenes.activeScene.go.push(SCG.GO.create("fadingObject",{position:this.position.clone(),imgPropertyName:"actions",destSourcePosition:new V2(250,0),size:new V2(50,50),lifeTime:5e3}))},addItem:function(n){if(this.items[n.itemType]=n,n.itemType=="weapon"){var t=this.getStats("attackRate");this.attackDelayTimer.currentDelay=t;this.attackDelayTimer.originDelay=t}},attack:function(n){var o=this.position.substract(n.position),r=0,i,u,t,e;if(o.x>0&&(r=2),o.y<0&&r++,i=this.getStats("damage"),u=getRandom(i.min,i.max)*(Math.random()<i.crit/100?3:1),this.getStats("ranged")){var h=this.position.direction(n.position),s=this.position.distance(n.position),f=[];for(t=0;t<10;t++)e=this.position.add(h.mul(s/10*(t+1))),e.y-=(-.04*Math.pow(t-5,2)+1)*s/5,f.push(e);SCG.scenes.activeScene.unshift.push(SCG.GO.create("projectile",{position:f.shift(),path:f,side:this.side,damage:u}))}else SCG.scenes.activeScene.unshift.push(SCG.GO.create("fadingObject",{position:this.position.clone(),imgPropertyName:"actions",destSourcePosition:new V2(r*50,0),size:new V2(50,50)})),SCG.audio.start({notes:[{value:200,duration:.7}],loop:!1}),SCG.audio.start({notes:[{value:1e3,duration:.3}],loop:!1}),n.receiveAttack(u);this.canAttackToggle()},internalUpdate:function(n){var f=this,r,u,i,t;if(Object.keys(this.items).forEach(function(n){f.items[n].update()}),this.canAttack){for(r=SCG.scenes.activeScene,u=r.go.length;u--;)if(i=r.go[u],i.type=="unit"&&i.side!=this.side&&this.position.distance(i.position)<this.getStats("attackRadius")){this.attack(i);break}}else doWorkByTimer(this.attackDelayTimer,n);if(t=this.jumpOptions,this.renderPosition&&(this.destination||t.current!=-1&&t.current<=t.end))this.renderPosition.y-=(-1*Math.pow(t.current,2)+1)*10;else return;t.current+=t.step;t.current>t.end&&(t.current=t.start)},internalRender:function(){SCG.context.translate(this.renderPosition.x,this.renderPosition.y);var n=this;Object.keys(this.items).forEach(function(t){n.items[t].render()});this.selected&&SCG.context.drawImage(SCG.images.actions,200,0,50,50,0-this.renderSize.x/2,0-this.renderSize.y/2,this.renderSize.x,this.renderSize.y);SCG.context.translate(-this.renderPosition.x,-this.renderPosition.y)}},{type:"line",size:new V2(1,1),isCustomRender:!0,customRender:function(){SCG.context.beginPath();SCG.context.rect(this.renderPosition.x-this.renderSize.x/2,this.renderPosition.y-this.renderSize.y/2,this.renderSize.x,this.renderSize.y);SCG.context.fillStyle="red";SCG.context.fill()}},{type:"projectile",damage:1,path:[],speed:5,destSourcePosition:new V2(40,0),imgPropertyName:"items",size:new V2(10,25),setDeadOnDestinationComplete:!0,angle:0,beforeDead:function(){for(var r=SCG.scenes.activeScene,t=this,i=r.go.filter(function(n){return n.type=="unit"&&n.side&&n.side!=t.side&&n.box.isPointInside(t.position)}),n=0;n<i.length;n++)i[n].receiveAttack(this.damage)},internalPreRender:function(){var t=SCG.context,n=this.renderPosition;t.translate(n.x,n.y);this.direction&&!this.direction.equal(new V2)&&(this.angle=V2.up().angleTo(this.direction,!0),t.rotate(this.angle));t.translate(-n.x,-n.y)},internalRender:function(){var t=SCG.context,n=this.renderPosition;t.translate(n.x,n.y);t.rotate(-this.angle);t.translate(-n.x,-n.y)}},{type:"fadingObject",lifeTime:500,alpha:1,shift:undefined,text:undefined,initializer:function(n){n.text&&(n.isCustomRender=!0)},internalPreRender:function(){SCG.context.save();SCG.context.globalAlpha=this.alpha},internalRender:function(){SCG.context.restore()},customRender:function(){var t=SCG.context,n=this.text;t.font=n.renderSize+"px Arial";n.color&&(t.fillStyle=n.color);t.fillText(n.value,this.renderPosition.x,this.renderPosition.y)},internalUpdate:function(n){this.alpha=1-(n-this.creationTime)/this.lifeTime;this.alpha<=0&&(this.alive=!1);this.shift!=undefined&&this.position.add(this.shift,!0);this.text&&(this.text.renderSize=this.text.size*SCG.gameControls.scale.times)}},{type:"item",size:new V2(10,50),imgPropertyName:"items",static:!0}],gameObjectGenerator:function(){var n=[];return n.push(SCG.GO.create("line",{position:new V2(0,500),size:new V2(1,1e3)})),n.push(SCG.GO.create("line",{position:new V2(100,500),size:new V2(1,1e3)})),n.push(SCG.GO.create("line",{position:new V2(200,500),size:new V2(1,1e3)})),n.push(SCG.GO.create("line",{position:new V2(300,500),size:new V2(1,1e3)})),n.push(SCG.GO.create("line",{position:new V2(500,0),size:new V2(1e3,1)})),n.push(SCG.GO.create("line",{position:new V2(500,100),size:new V2(1e3,1)})),n.push(SCG.GO.create("line",{position:new V2(500,200),size:new V2(1e3,1)})),n.push(SCG.GO.create("line",{position:new V2(500,300),size:new V2(1e3,1)})),n}},n={name:"management",space:{width:500,height:300},dispose:function(){},start:function(n){var e=this.game.selectedUnit.statsControls,t,s,r,u,f,o;if(e.initialized||e.initialize(),t=this,n.fromBattle?(this.go=n.gos,this.game.money=n.money):n.fromUTSelect&&this.go.push(SCG.GO.create("unit",{position:new V2,size:new V2(50,50),health:100,unitType:n.type})),s=undefined,this.go.forEach(function(i,r){i.position=new V2(i.size.x/2,i.size.y/2+r*50);n.fromItemSelect||(i.selected=!1);i.regClick();t.ui.push(SCG.GO.create("label",{position:new V2(i.position.x+i.size.x/4,i.position.y-i.size.y/4),size:new V2(i.size.x/2,i.size.y/2),text:{size:25,color:"green",value:i.unitType.substring(0,1)}}))}),this.go.length<6)for(r=this.go.length;r<7;r++)(function(n){t.ui.push(SCG.GO.create("button",{position:new V2(25,25+n*50),text:{value:"HIRE",autoSize:!0,font:"Arial"},handlers:{click:function(){return SCG.scenes.selectScene(i.name),{preventBubbling:!0}}}}))})(r);u=this.game.selectedUnit.statsControls.labels;Object.keys(u).forEach(function(n){t.ui.push(u[n])});f=this.game.selectedUnit.statsControls.buttons;Object.keys(f).forEach(function(n){t.ui.push(f[n])});t.ui.push(SCG.GO.create("image",{position:new V2(170,220),size:new V2(150,150),destSourcePosition:new V2(0,0),destSourceSize:new V2(50,50),imgPropertyName:"unit"}));n.fromItemSelect?(o=this.game.selectedUnit.unit,n.item&&o.addItem(SCG.GO.create("item",n.item)),this.game.unitSelected(this.game.selectedUnit.unit)):this.game.selectedUnit.unit=undefined;SCG.UI.invalidate()},backgroundRender:function(){SCG.globals.bgRender()},preMainWork:function(){SCG.context.clearRect(0,0,SCG.viewfield.width,SCG.viewfield.height)},game:{money:0,selectedUnit:{unit:undefined,statsControls:{initialized:!1,initialize:function(){this.labels.hp=SCG.GO.create("label",{position:new V2(110,50),size:new V2(100,30),text:{size:15,color:"Red",value:0,format:"Health: {0}"}});this.labels.str=SCG.GO.create("label",{position:new V2(110,70),size:new V2(100,30),text:{size:15,value:0,format:"Strenght: {0}"}});this.labels.agl=SCG.GO.create("label",{position:new V2(110,90),size:new V2(100,30),text:{size:15,value:0,format:"Agility: {0}"}});this.labels.con=SCG.GO.create("label",{position:new V2(110,110),size:new V2(100,30),text:{size:15,value:0,format:"Constitution: {0}"}});this.labels.rte=SCG.GO.create("label",{position:new V2(110,130),size:new V2(200,30),text:{size:15,value:0,format:"Attack rate: {0}"}});this.labels.lvl=SCG.GO.create("label",{position:new V2(250,50),size:new V2(100,30),text:{size:15,color:"Blue",value:0,format:"Level: {0}"}});this.labels.exp=SCG.GO.create("label",{position:new V2(250,70),size:new V2(200,30),text:{size:15,value:"0-0",format:"Experience: {0}"}});this.labels.atk=SCG.GO.create("label",{position:new V2(250,90),size:new V2(200,30),text:{size:15,value:"0-0",format:"Attack: {0}"}});this.labels.def=SCG.GO.create("label",{position:new V2(250,110),size:new V2(100,30),text:{size:15,value:0,format:"Defence: {0}"}});this.labels.rng=SCG.GO.create("label",{position:new V2(250,130),size:new V2(100,30),text:{size:15,value:0,format:"Range: {0}"}});this.buttons.wpn=SCG.GO.create("button",{position:new V2(105,220),size:new V2(40,120),border:!0,useInnerCanvas:!1,handlers:{click:function(){var n=SCG.scenes.activeScene.game.selectedUnit.unit;return SCG.scenes.activeScene.game.selectedUnit.unit?SCG.scenes.selectScene(r.name,{unitType:n.unitType,itemType:"weapon"}):alert("No selected unit"),{preventBubbling:!0}}}})},labels:{},buttons:{}}},unitSelected:function(n){var t,r,i;this.selectedUnit.unit=n;t=this.selectedUnit.statsControls.labels;t.hp.text.value=n.health;t.str.text.value=n.stats.str;t.agl.text.value=n.stats.agl;t.con.text.value=n.stats.con;t.lvl.text.value=n.level;t.exp.text.value=String.format("{0}-{1}",n.experience,n.getStats("expCap"));r=n.getStats("damage");t.atk.text.value=String.format("{0}-{1}({2}%)",r.min,r.max,r.crit);t.def.text.value=n.getStats("defence");t.rng.text.value=n.getStats("attackRadius");t.rte.text.value=n.getStats("attackRate");i=this.selectedUnit.statsControls.buttons;n.items.weapon?(i.wpn.img=n.items.weapon.img,i.wpn.destSourcePosition=n.items.weapon.destSourcePosition,i.wpn.destSourceSize=n.items.weapon.size):i.wpn.img=undefined;SCG.UI.invalidate()}}},i={name:"ut_select",space:{width:SCG.viewfield.default.width,height:SCG.viewfield.default.height},start:function(){for(var i,r=this,t=0;t<3;t++)(function(t){var i=function(n){switch(n){case 0:return"Fighter";case 1:return"Defender";case 2:return"Ranged"}}(t);r.ui.push(SCG.GO.create("button",{position:new V2(95+150*t,150),size:new V2(150,250),text:{value:i,autoSize:!0,font:"Arial"},handlers:{click:function(){return SCG.scenes.selectScene(n.name,{fromUTSelect:!0,type:i}),{preventBubbling:!0}}}}))})(t);i=SCG.viewfield;SCG.context.clearRect(0,0,i.width,i.height);SCG.UI.invalidate()},preMainWork:function(){SCG.context.clearRect(0,0,SCG.viewfield.width,SCG.viewfield.height)},backgroundRender:function(){SCG.globals.bgRender()}},r={name:"item_select",space:{width:SCG.viewfield.default.width,height:SCG.viewfield.default.height},start:function(t){var r=this,u=this.space,i=new V2(u.width*.8/3,u.height*.7/3),e=new V2(u.width*.1,u.height*.15),f;r.ui.push(SCG.GO.create("button",{position:new V2(u.width*.95,u.height*.05),size:new V2(50,30),text:{value:"Close",color:"red",autoSize:!0,font:"Arial"},handlers:{click:function(){return SCG.scenes.selectScene(n.name,{fromItemSelect:!0,item:undefined}),{preventBubbling:!0}}}}));SCG.globals.items.filter(function(n){return n.itemType==t.itemType&&n.unitTypes.indexOf(t.unitType)!=-1}).forEach(function(t,u){var h=parseInt(u/3),l=u-h*3,s=new V2(e.x+i.x/2+i.x*l,e.y+i.y/2+i.y*h);r.ui.push(SCG.GO.create("button",{position:s,size:i,text:{value:"",autoSize:!0,font:"Arial"},handlers:{click:function(){return SCG.scenes.selectScene(n.name,{fromItemSelect:!0,item:t}),{preventBubbling:!0}}}}));var c=t.size.mul(i.y/t.size.y),a=s.substract(new V2(i.x/2-c.x/2-i.x*.05),0),o=s.substract(new V2(-15,i.y/2)),f=new V2(100,i.y/4);r.ui.push(SCG.GO.create("image",{position:a,size:c,destSourcePosition:t.destSourcePosition,destSourceSize:t.size,imgPropertyName:"items"}));r.ui.push(SCG.GO.create("label",{position:o.add(new V2(0,f.y/2)),size:f,text:{color:"Red",value:0,format:"Price: {0}"}}));r.ui.push(SCG.GO.create("label",{position:o.add(new V2(0,1.5*f.y)),size:f,text:{size:10,value:String.format("Damage {0}-{1}({2}%)",t.damage.min,t.damage.max,t.damage.crit)}}));r.ui.push(SCG.GO.create("label",{position:o.add(new V2(0,2.5*f.y)),size:f,text:{size:10,value:t.attackRate,format:"Rate: {0}"}}));r.ui.push(SCG.GO.create("label",{position:o.add(new V2(0,3.5*f.y)),size:f,text:{size:10,value:t.attackRadius,format:"Range: {0}"}}))});f=SCG.viewfield;SCG.context.clearRect(0,0,f.width,f.height);SCG.UI.invalidate()},preMainWork:function(){SCG.context.clearRect(0,0,SCG.viewfield.width,SCG.viewfield.height)},backgroundRender:function(){SCG.globals.bgRender()}};SCG.customInitializaers.push(function(){var s=document.createElement("canvas"),f,n,h,e,t,r,o,i;for(s.width=100,s.height=50,f=s.getContext("2d"),n=0,h=0;h<2;h++)drawFigures(f,[[new V2(20+n,11.5),new V2(30+n,11.5),{type:"curve",control:new V2(40+n,10),p:new V2(38.5+n,20)},new V2(38.5+n,30),{type:"curve",control:new V2(40+n,40),p:new V2(30+n,38.5)},new V2(20+n,38.5),{type:"curve",control:new V2(10+n,40),p:new V2(11.5+n,30)},new V2(11.5+n,20),{type:"curve",control:new V2(10+n,10),p:new V2(20+n,11.5)}],[new V2(1+n,20),new V2(10+n,20),new V2(10+n,30),new V2(1+n,30),new V2(1+n,20)],[new V2(40+n,20),new V2(49+n,20),new V2(49+n,30),new V2(40+n,30),new V2(40+n,20)]],{alpha:1,fill:h==0?"white":"#dcdcdc",stroke:"black"}),f.fillRect(19+n,20,2,2),f.fillRect(29+n,20,2,2),f.fillRect(20+n,25,10,2),n+=50;SCG.images.unit=s;e=document.createElement("canvas");e.width=70;e.height=100;t=e.getContext("2d");n=0;var u=0,c=["#cd7f32","#f2f2f2","#baacc7"],l=["#b87333","#c0c0c0","#876f9e"],a=["bronze","steel","mithril"];for(r=0;r<3;r++)drawFigures(t,[[new V2(2.5+n,30),new V2(2.5+n,15),new V2(5+n,12.5),new V2(7.5+n,15),new V2(7.5+n,30)]],{alpha:1,fill:c[r],stroke:l[r]}),t.fillStyle="#ffd700",t.fillRect(1.5+n,30,7,2),t.fillStyle="#5b3a29",t.fillRect(3.5+n,32,3,3),SCG.globals.items.push({itemName:a[r]+" sword",position:new V2(-20,-7),attackRadius:10,damage:{min:1*(r+1),max:5*(r+1),crit:5},attackRate:1e3,destSourcePosition:new V2(n,0),size:new V2(10,50),itemType:"weapon",unitTypes:["Fighter"]}),u=50,drawFigures(t,[[new V2(7.5+n,20+u),new V2(5+n,22.5+u),{type:"curve",control:new V2(1.5+n,17.5+u),p:new V2(5+n,12.5+u)},new V2(7.5+n,15+u)]],{alpha:1,fill:c[r],stroke:l[r]}),t.fillStyle="#5b3a29",t.fillRect(7+n,15+u,1.5,20),SCG.globals.items.push({itemName:a[r]+" axe",position:new V2(-20,-7),attackRadius:5,damage:{min:5*(r+1),max:15*(r+1),crit:2},attackRate:1500,destSourcePosition:new V2(n,u),size:new V2(10,50),itemType:"weapon",unitTypes:["Fighter"]}),n+=10;t.lineWidth=2;drawFigures(t,[[new V2(15+n,45),{type:"curve",control:new V2(0+n,25),p:new V2(15+n,5)}]],{alpha:1,stroke:"#5b3a29"});t.lineWidth=1;drawFigures(t,[[new V2(15+n,45),new V2(15+n,5)]],{alpha:1,stroke:"#black"});n+=20;drawFigures(t,[[new V2(3+n,25),new V2(5+n,22),new V2(7+n,25)]],{alpha:1,stroke:"#dc143c"});t.fillStyle="#964b00";t.fillRect(4.5+n,5,1,17);drawFigures(t,[[new V2(3+n,7),new V2(5+n,3),new V2(7+n,7)]],{alpha:1,stroke:"#c0c0c0"});n+=10;t.lineWidth=2;drawFigures(t,[[new V2(15+n,35),{type:"curve",control:new V2(5+n,25),p:new V2(15+n,15)}]],{alpha:1,stroke:"#5b3a29"});t.lineWidth=1;drawFigures(t,[[new V2(15+n,35),new V2(15+n,15)]],{alpha:1,stroke:"#black"});SCG.images.items=e;o=document.createElement("canvas");o.width=300;o.height=50;i=o.getContext("2d");i.lineWidth=5;drawFigures(i,[[new V2(5,3),{type:"curve",control:new V2(50,0),p:new V2(45,47.5)}]],{alpha:1,stroke:"#87cefa"});n=50;drawFigures(i,[[new V2(45+n,5),{type:"curve",control:new V2(50+n,50),p:new V2(5+n,47)}]],{alpha:1,stroke:"#87cefa"});n=100;drawFigures(i,[[new V2(5+n,47),{type:"curve",control:new V2(0+n,0),p:new V2(45+n,3)}]],{alpha:1,stroke:"#87cefa"});n=150;drawFigures(i,[[new V2(45+n,47),{type:"curve",control:new V2(0+n,50),p:new V2(5+n,3)}]],{alpha:1,stroke:"#87cefa"});n=200;i.lineWidth=1;drawFigures(i,[[new V2(1+n,0),new V2(10+n,0),new V2(1+n,10)],[new V2(40+n,0),new V2(49+n,0),new V2(49+n,10)],[new V2(49+n,40),new V2(49+n,50),new V2(40+n,50)],[new V2(10+n,50),new V2(1+n,50),new V2(1+n,40)]],{alpha:1,fill:"#ffd700",stroke:"#998200"});n=250;drawFigures(i,[[new V2(10+n,40),new V2(10+n,20),{type:"curve",control:new V2(25+n,10),p:new V2(40+n,20)},new V2(40+n,40)]],{alpha:1,fill:"#4b4d4b"});i.fillStyle="#5da130";i.fillRect(5+n,40,40,5);i.fillStyle="#1b1116";i.fillRect(15+n,25,20,5);i.fillStyle="#1b1116";i.fillRect(15+n,32,20,2);SCG.images.actions=o});SCG.gameControls.camera.resetAfterUpdate=!0;SCG.scenes.registerScene(t);SCG.scenes.registerScene(n);SCG.scenes.registerScene(i);SCG.scenes.registerScene(r);SCG.scenes.selectScene(t.name);SCG.start()});